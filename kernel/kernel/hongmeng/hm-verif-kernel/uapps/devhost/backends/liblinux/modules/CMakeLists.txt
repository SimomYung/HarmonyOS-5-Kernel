#
# Build liblinux modules
#

add_custom_target(lkm
    ALL
    COMMAND ${CMAKE_COMMAND} -E env
		# clear potential conflict env set by devhost
		--unset=KCONFIG_CONFIG
		--unset=LDFLAGS
		--unset=srctree
		--unset=MAKEFLAGS
		--unset=SRC
		--unset=MFLAGS
		--unset=KBUILD_SRC
		ARCH=${ARCH}
		CROSS_COMPILE=${CROSS_COMPILE}
		MAKE=make
		HMSDKSYSROOTPATH=${HMSDKSYSROOTPATH}
		LIBLINUX_VERSION=${CONFIG_LIBLINUX_VERSION}
		LIBLINUX_KDIR=${LIBLINUX_KDIR}
		CONFIG_MDC_GODEL_HACK=${CONFIG_MDC_GODEL_HACK}
		CONFIG_DEVHOST_VITS_PCI_MSI=${CONFIG_DEVHOST_VITS_PCI_MSI}
		CONFIG_DEVHOST_TTY=${CONFIG_TTY}
		CONFIG_SERIAL_KSHORTCUT_SYS_PAUSE=${CONFIG_SERIAL_KSHORTCUT_SYS_PAUSE}
		CONFIG_SERIAL_KSHORTCUT_TRIGGER_SNAPSHOT=${CONFIG_SERIAL_KSHORTCUT_TRIGGER_SNAPSHOT}
		CONFIG_DEVHOST_NETLINK=${CONFIG_DEVHOST_NETLINK}
		CONFIG_DEVHOST_PM_PLUGIN=${CONFIG_DEVHOST_PM_PLUGIN}
		CONFIG_DEVHOST_FS_TRANSFS=${CONFIG_DEVHOST_FS_TRANSFS}
		CONFIG_UBIFS_CTRL=${CONFIG_UBIFS_CTRL}
		CONFIG_STRIP_OPTION=${CONFIG_STRIP_OPTION}
		EXTLIB_OUTPUT=${CMAKE_CURRENT_BINARY_DIR}
		EXTLIB_SRC=${CMAKE_CURRENT_SOURCE_DIR}
		DEVHOST_API_CFLAGS=${dh-api-include}
		DEVHOST_COMMON_CFLAGS=${dh-common-include}
		NOSTDINC_FLAGS=""
		# before non-versioned lkm is removed, this cmake may be used to compile ldk5 modules
		# and ldk5 require setting this to avoid error when executing modpost
		KBUILD_MODPOST_WARN=1
		bash ${CMAKE_CURRENT_SOURCE_DIR}/build.sh
    )
add_dependencies(global lkm)
